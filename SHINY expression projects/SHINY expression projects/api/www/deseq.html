<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DESeq2 Differential Expression</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#2C097F",
              "background-light": "#fafafa",
              "background-dark": "#151022",
              "sidebar-dark": "#131118"
            },
            fontFamily: {
              display: ["system-ui", "sans-serif"]
            }
          }
        }
      };
    </script>

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;500;700&display=swap"
    />

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      const storedSidebarPref = localStorage.getItem("expression-sidebar");

      function updateThemeIcon(isDark) {
        const icon = document.getElementById("theme-icon");
        if (icon) icon.textContent = isDark ? "light_mode" : "dark_mode";
      }

      function updateSidebarToggle(isHidden) {
        const icon = document.getElementById("sidebar-toggle-icon");
        const label = document.getElementById("sidebar-toggle-label");
        if (icon) icon.textContent = isHidden ? "chevron_right" : "chevron_left";
        if (label) label.textContent = isHidden ? "Show Sidebar" : "Hide Sidebar";
      }

      function setSidebarHidden(isHidden) {
        const sidebar = document.getElementById("app-sidebar");
        if (sidebar) sidebar.classList.toggle("hidden", isHidden);
        document.body.dataset.sidebarHidden = isHidden ? "true" : "false";
        updateSidebarToggle(isHidden);
      }

      function toggleSidebar() {
        const shouldHide = document.body?.dataset.sidebarHidden !== "true";
        setSidebarHidden(shouldHide);
        localStorage.setItem(
          "expression-sidebar",
          shouldHide ? "hidden" : "visible"
        );
      }

      (function () {
        const stored = localStorage.getItem("theme");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const root = document.documentElement;
        const useDark = stored === "dark" || (!stored && prefersDark);
        root.classList.toggle("dark", useDark);
      })();

      function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        updateThemeIcon(isDark);
      }

      /* -----------------------------------------
         RUN DESEQ2
      ----------------------------------------- */
      async function runDESeq() {
        const fileInput = document.getElementById("counts-file");
        const group1Input = document.getElementById("group1");
        const group2Input = document.getElementById("group2");
        const statusEl = document.getElementById("deseq-status");
        const runBtn = document.getElementById("run-deseq-btn");

        if (!fileInput.files.length) {
          alert("Upload a counts file first.");
          return;
        }

        const file = fileInput.files[0];
        const g1 = group1Input.value;
        const g2 = group2Input.value;

        if (!g1 || !g2) {
          alert("Provide sample names for both Group 1 and Group 2.");
          return;
        }

        try {
          document.body.dataset.loading = "true";
          runBtn.disabled = true;
          statusEl.textContent = "Running DESeq2…";

          const form = new FormData();
          form.append("counts_file", file);
          form.append(
            "payload",
            JSON.stringify({ group1: g1, group2: g2 })
          );

          const res = await axios.post("/api/deseq", form, {
            headers: { "Content-Type": "multipart/form-data" }
          });

          statusEl.textContent = "DESeq2 run complete.";

          renderDESeqTable(res.data.results);

        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error running DESeq2.";
        } finally {
          document.body.dataset.loading = "false";
          runBtn.disabled = false;
        }
      }

      /* -----------------------------------------
         RENDER TABLE
      ----------------------------------------- */
      function renderDESeqTable(rows) {
        const container = document.getElementById("deseq-table-container");
        container.innerHTML = "";

        if (!rows || !rows.length) {
          container.innerHTML = "<p>No results.</p>";
          return;
        }

        const columns = Object.keys(rows[0]).filter(c => c !== "_row");

        let html = `
          <div class="overflow-auto max-h-[600px] border rounded-lg">
          <table class="min-w-full text-xs text-gray-800 dark:text-gray-200">
          <thead class="bg-gray-100 dark:bg-gray-700">
            <tr>
              ${columns.map(c => `<th class="px-3 py-2 text-left font-semibold">${c}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
        `;

        html += rows.map(r => `
          <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
            ${columns.map(c => `<td class="px-3 py-1">${r[c] ?? ""}</td>`).join("")}
          </tr>
        `).join("");

        html += `
          </tbody>
          </table>
          </div>
        `;

        container.innerHTML = html;
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateThemeIcon(document.documentElement.classList.contains("dark"));
        setSidebarHidden(storedSidebarPref === "hidden");

        const fileInput = document.getElementById("counts-file");
        const fileStatus = document.getElementById("counts-status");
        if (fileInput && fileStatus) {
          fileInput.addEventListener("change", () => {
            fileStatus.textContent = fileInput.files.length
              ? `Selected: ${fileInput.files[0].name}`
              : "No file selected.";
          });
        }
      });
    </script>

    <style>
      #loading-indicator {
        display: none;
      }
      body[data-loading="true"] #loading-indicator {
        display: flex;
      }
    </style>
  </head>

  <body
    class="h-screen bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-100"
  >
    <div class="flex h-full">
      <!-- Sidebar -->
      <aside
        id="app-sidebar"
        class="w-[390px] shrink-0 border-r border-gray-200/70 dark:border-white/10 bg-white/90 dark:bg-sidebar-dark backdrop-blur flex flex-col px-6 py-6 gap-6 overflow-y-auto"
      >
        <div class="flex flex-col">
          <h1 class="text-gray-900 dark:text-white text-base font-semibold">
            DESeq2 Differential Expression
          </h1>
          <p class="text-gray-500 dark:text-gray-400 text-sm">
            Upload counts & define groups to run DESeq2.
          </p>
        </div>

        <div class="flex flex-col gap-4">

          <!-- Counts upload -->
          <div class="flex flex-col gap-4">
            <p class="text-lg font-semibold text-gray-900 dark:text-white">Counts Matrix</p>

            <div class="flex items-center gap-4 px-4 min-h-[72px] py-2 justify-between rounded-lg border border-gray-200 dark:border-white/10">
              <div class="flex items-center gap-4">
                <div class="text-primary flex items-center justify-center rounded-lg bg-primary/10 size-12">
                  <span class="material-symbols-outlined">upload_file</span>
                </div>
                <div class="flex flex-col">
                  <p class="text-zinc-900 dark:text-white text-base font-medium">
                    Counts (raw)
                  </p>
                  <p class="text-zinc-500 dark:text-gray-400 text-sm">
                    Upload CSV or TXT matrix
                  </p>
                </div>
              </div>

              <div>
                <input id="counts-file" type="file" accept=".csv,.txt" class="hidden" />
                <button
                  type="button"
                  onclick="document.getElementById('counts-file').click()"
                  class="rounded-lg h-8 px-4 bg-zinc-100 text-zinc-700 text-sm hover:bg-zinc-200"
                >
                  Browse
                </button>
              </div>
            </div>

            <p id="counts-status" class="px-4 text-xs text-gray-500 dark:text-gray-400">
              No file selected.
            </p>
          </div>

          <!-- Groups -->
          <details class="flex flex-col rounded-lg border border-gray-200 dark:border-white/10 px-4" open>
            <summary class="flex cursor-pointer items-center justify-between py-3">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-2xl">groups</span>
                <p class="text-sm font-medium">Sample Groups</p>
              </div>
              <span class="material-symbols-outlined">expand_more</span>
            </summary>

            <div class="pb-4 pt-1 flex flex-col gap-3">
              <p class="text-xs text-gray-500">
                Enter sample IDs separated by commas.
              </p>
              <label class="flex flex-col gap-1 text-xs font-medium">
                <span>Group 1 Samples</span>
                <input id="group1" type="text" class="h-9 rounded-md border px-2 text-sm" />
              </label>
              <label class="flex flex-col gap-1 text-xs font-medium">
                <span>Group 2 Samples</span>
                <input id="group2" type="text" class="h-9 rounded-md border px-2 text-sm" />
              </label>
            </div>
          </details>

          <!-- Run -->
          <div class="flex flex-col rounded-lg border px-4 py-3 gap-3">
            <button
              id="run-deseq-btn"
              onclick="runDESeq()"
              class="rounded-md bg-primary text-white text-sm font-semibold h-10 px-4 hover:bg-primary/90"
            >
              <span class="material-symbols-outlined text-sm mr-1">play_arrow</span>
              Run DESeq2
            </button>
            <p id="deseq-status" class="text-xs text-gray-500">Ready to run.</p>
          </div>
        </div>
      </aside>

      <!-- Results -->
      <main class="flex-1 p-8 overflow-y-auto">
        <div class="flex flex-col h-full relative">

          <!-- Top buttons -->
          <div class="flex justify-end gap-2 mb-4">
            <a href="/" class="inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs">
              <span class="material-symbols-outlined text-sm">home</span> Home
            </a>
            <button onclick="toggleTheme()" class="inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs">
              <span id="theme-icon" class="material-symbols-outlined text-sm">dark_mode</span>
              Theme
            </button>
            <button onclick="toggleSidebar()" class="inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs">
              <span id="sidebar-toggle-icon" class="material-symbols-outlined text-sm">chevron_left</span>
              <span id="sidebar-toggle-label">Hide Sidebar</span>
            </button>
          </div>

          <!-- Results Box -->
          <div class="flex-1 flex items-stretch justify-center rounded-xl border bg-white/60 dark:bg-background-dark/40 relative">
            <div class="flex flex-col w-full h-full">

              <div class="border-b px-4 py-3">
                <p class="text-sm font-semibold">DESeq2 Results</p>
                <p class="text-xs text-gray-500">Table of differential expression results</p>
              </div>

              <div class="flex-1 overflow-auto p-4">

                <!-- Hidden element so JS does not crash -->
                <pre id="deseq-output" class="hidden"></pre>

                <!-- Visible table -->
                <div id="deseq-table-container" class="mt-4"></div>

              </div>
            </div>

            <div id="loading-indicator" class="absolute inset-0 items-center justify-center">
              <div class="flex flex-col items-center gap-3 rounded-lg px-4 py-3">
                <div class="h-6 w-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                <p class="text-xs">Running DESeq2…</p>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>
  </body>
</html>
